<div class="grid">
    <div class="col-12">
        <div class="card px-6 py-6">

            <p-toolbar styleClass="mb-4" *ngIf="!_esAsistenteDDC">
                <ng-template pTemplate="left">
                    <div class="my-2">
                        <h3>Agrupar Cotizaciones Activas</h3>
                        <button style="border-radius: 2rem; font-size: 1rem;" pButton pRipple label="ATRÁS"
                            icon="pi pi-times" class="boton p-button-danger" (click)="volverListado()"></button>
                    </div>
                </ng-template>
            </p-toolbar>

            <div class="card">
                <p-tabView orientation="left">
                    <p-tabPanel header="Listado" class="line-height-3 m-0">

                        <ng-container *ngIf="_cotizacionesYaAgrupadas$ | async as cotizaciones">
                            <p-table [value]="cotizaciones" [tableStyle]="{ 'min-width': '50rem' }" [globalFilterFields]="['consecutivo','fechaHora','cotizaciones']" #dt>

                                <ng-template pTemplate="header">
                                    <tr>
                                        <th pSortableColumn="consecutivo">Cotización<p-sortIcon field="consecutivo"></p-sortIcon></th>
                                        <th>Agente</th>
                                        <th pSortableColumn="fechaHora">Fecha<p-sortIcon field="fechaHora"></p-sortIcon></th>
                                        <th>Monto</th>
                                        <th>Cantidad</th>
                                        <th pSortableColumn="cotizaciones">Cotizaciones<p-sortIcon field="cotizaciones"></p-sortIcon></th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </ng-template>

                                <ng-template pTemplate="body" let-item>
                                    <tr>
                                        <td>DDC-AG-{{colocaCerosAlNumeroEntero(item.consecutivo)}}-{{_anno}}</td>
                                        <td>{{ item.nombreCorto }}</td>
                                        <td>{{ item.fechaHora | date : 'dd/MM/yyyy HH:mm' }}</td>
                                        <td>{{ item.montoDolares | currency : '$' }}</td>
                                        <td>{{ item.cantidad | number : '1.2-2'}}</td>
                                        <td>{{ item.cotizaciones }}</td>
                                        <td>
                                            <span class="p-column-title">Estado</span>
                                            <p-tag [value]="item.indicadorEstado" [style]="determinaColorDeEstado(item.indicadorEstado)" />
                                        </td>
                                        <td>
                                            <button *ngIf="esParaFormalizar(item)" (click)="mostrarFormalizacion(item)"
                                                pButton pRipple icon="pi pi-dollar" pTooltip="Formalizar"
                                                tooltipPosition="top"
                                                style="background-color: #2563eb; border-radius: 2rem; font-size: 1rem;"
                                                class="p-button-rounded mr-2"></button>
                                            <button *ngIf="esParaAnular(item)"
                                                (click)="anularCotizacion(item.consecutivo)" pButton pRipple
                                                icon="pi pi-ban" pTooltip="Anular" tooltipPosition="top"
                                                class="p-button-rounded p-button-danger mr-2"
                                                style="border-radius: 2rem; font-size: 1rem;"></button>
                                            <button *ngIf="esParaAprobar(item)" (click)="verAgrupacion(item)" pButton
                                                pRipple icon="pi pi-check" pTooltip="Aprobar" tooltipPosition="top"
                                                class="p-button-rounded p-button-danger mr-2"
                                                style="background-color: #4CAF50; border-radius: 2rem; font-size: 1rem;"></button>
                                        </td>
                                    </tr>
                                </ng-template>

                            </p-table>
                        </ng-container>

                    </p-tabPanel>
                    <p-tabPanel header="Agrupar" class="line-height-3 m-0" *ngIf="_esAgente">

                        <p-pickList [source]="_cotizacionesActivas" [target]="_cotizacionesAgrupadas" (onMoveToTarget)="haciaElTarget($event)"
                            sourceHeader="Cotizaciones Activas" targetHeader="Agrupación" [dragdrop]="true" (onMoveToSource)="haciaElOrigen($event)"
                            [responsive]="true" [sourceStyle]="{'height':'250px'}" [targetStyle]="{'height':'250px'}"
                            filterBy="consecutivo">
                            <ng-template let-item pTemplate="item">
                                <div>DDC-CO-{{colocaCerosAlNumeroEntero(item.consecutivo)}}-{{_anno}}:
                                    {{item.nombreCliente}}
                                </div>
                            </ng-template>
                        </p-pickList>

                        <div class="my-2" style="text-align: right;">
                            <button [disabled]="_desHabilitaAplicarAgrupacion" pButton pRipple label="Aplicar" style="border-radius: 2rem; font-size: 1.2rem;"
                                (click)="guardarListadoAgrupado()"></button>
                        </div>

                    </p-tabPanel>
                </p-tabView>
            </div>

        </div>
    </div>
</div>

<p-dialog header="Formalizar Venta" [modal]="true" [(visible)]="_mostrarFormalizacion" [style]="{ width: '50rem' }">
    <span class="p-text-secondary block mb-5">Cotización Número: {{_consecutivo}}</span>

    <div class="flex align-items-center gap-3 mb-3">
        <label for="comprobantePago" class="font-semibold w-12rem">¿Es a Crédito?</label>
        <p-toggleButton [(ngModel)]="_credito" onLabel="Sí" offLabel="No" (onChange)="formalizacionCredito($event)" />
    </div>

    <!-- <div class="flex align-items-center gap-3 mb-3">
        <label for="codigoCIUU" class="font-semibold w-12rem">Código CIUU</label>
        <input pInputText id="codigoCIUU" type="text" class="flex-auto" autocomplete="off" (focus)="entraComprobante()"
            (blur)="validaComprobantes()" maxlength="10" />
        <small *ngIf="_esRequeridoComprobante" style="color: red;">El código es requerido.</small>
        <small *ngIf="_esFormatoIncorrecto" style="color: red;">Formato incorrecto.</small>
    </div> -->

    <div class="flex align-items-center gap-3">
        <label for="fechaFormalizacion" class="font-semibold w-12rem">Fecha Formalización</label>
        <input pInputText id="fechaFormalizacion" type="date" class="flex-auto" autocomplete="off"
            (focus)="entraFecha()" (blur)="saleFecha()" />
    </div>
    <small *ngIf="_fechaValidaRequerida" style="color: red;">La fecha debe ser válida.</small>
    <small *ngIf="_fechaInvalidaCotizacion" style="color: red;">La fecha debe ser mayor o igual a la de Cotización:
        {{_fechaCotizacionHecha | date: 'dd/MM/yyyy'}}</small>
    <small *ngIf="_fechaInvalidaExpiracion" style="color: red;">La fecha debe ser menor o igual a la de Expiración:
        {{_fechaExpiracion | date: 'dd/MM/yyyy'}}.</small>

    <div class="flex align-items-center gap-3 mt-3 mb-5">
        <label for="montoDolares" class="font-semibold w-12rem">Monto Dólares</label>
        <input pInputText id="montoDolares" class="flex-auto" autocomplete="off" disabled="true" />
    </div>

    <div class="flex justify-content-end gap-2">
        <button pButton pRipple style="border-radius: 2rem;font-size: 1.25rem;" class="p-button-success mr-2"
            label="Aplicar" icon="pi pi-save" (click)="formalizarVenta()" [loading]="_guardando"
            [disabled]="_desHabilitarAplicar"></button>
        <button pButton pRipple style="border-radius: 2rem;font-size: 1.25rem;" class="p-button-danger mr-2"
            label="Cancelar" icon="pi pi-times" (click)="cancelarFormalizacion()"></button>
    </div>
</p-dialog>

<p-dialog header="Aprobación para Formalizar" [modal]="true" [(visible)]="_mostrarAgrupacion" [style]="{ width: '75rem' }">

    <ng-container *ngIf="_cotizaciones$ | async as cotizaciones">
        <p-table [value]="cotizaciones" [tableStyle]="{ 'min-width': '70rem' }">

            <ng-template pTemplate="header">
                <tr>
                    <th>Cotización</th>
                    <th>Agente</th>
                    <th>Fecha</th>
                    <th>Monto</th>
                    <th>Cantidad</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-item>
                <tr>
                    <td>DDC-CO-{{colocaCerosAlNumeroEntero(item.consecutivo)}}-{{_anno}}</td>
                    <td>{{ item.nombreCorto }}</td>
                    <td>{{ item.fechaHora | date : 'dd/MM/yyyy HH:mm' }}</td>
                    <td>{{ item.montoTotalDolares | currency : '$' }}</td>
                    <td>{{ item.cantidad | number : '1.2-2'}}</td>
                </tr>
            </ng-template>

        </p-table>
    </ng-container>

    <div class="flex justify-content-end gap-2 mt-5">
        <button pButton pRipple style="border-radius: 2rem;font-size: 1.25rem;" class="p-button-success mr-2"
            label="Aprobar" icon="pi pi-check" (click)="aprobarAgrupacion()" [loading]="_guardando"
            [disabled]="_desHabilitarAplicar"></button>
        <button pButton pRipple style="border-radius: 2rem;font-size: 1.25rem;" class="p-button-danger mr-2"
            label="Rechazar" icon="pi pi-times" (click)="cancelarAprobacion()"></button>
    </div>
</p-dialog>